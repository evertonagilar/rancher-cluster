---
- name: Add Bitnami Helm repository
  kubernetes.core.helm_repository:
    name: bitnami
    repo_url: "{{ bitnami_chart_repo }}"
  when: use_bitnami_chart | bool

- name: Create Helm values file from template
  ansible.builtin.template:
    src: values.yaml.j2
    dest: /tmp/openldap-values.yaml
    mode: "0644"

- name: Install OpenLDAP via Helm
  kubernetes.core.helm:
    name: openldap
    chart_ref: "bitnami/{{ bitnami_chart_name }}"
    chart_version: "{{ bitnami_chart_version if bitnami_chart_version else omit }}"
    release_namespace: "{{ ldap_namespace }}"
    create_namespace: false
    values_files:
      - /tmp/openldap-values.yaml
    kubeconfig: "{{ kubeconfig_path }}"
    wait: true
    wait_timeout: 5m
  when: use_bitnami_chart | bool
