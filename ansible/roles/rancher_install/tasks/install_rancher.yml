---
- name: Check if Rancher is installed
  ansible.builtin.command:
    cmd: helm status rancher -n cattle-system
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: rancher_status
  failed_when: false
  changed_when: false

- name: Generate Rancher Helm values file
  ansible.builtin.template:
    src: values.yaml.j2
    dest: /tmp/rancher-values.yaml
    mode: "0644"
  when: rancher_status.rc != 0

- name: Install Rancher via Helm
  ansible.builtin.command:
    cmd: >
      helm install rancher rancher-stable/rancher
      --namespace cattle-system
      --values /tmp/rancher-values.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: rancher_status.rc != 0
  changed_when: true

- name: Clean up temporary values file
  ansible.builtin.file:
    path: /tmp/rancher-values.yaml
    state: absent
  when: rancher_status.rc != 0
