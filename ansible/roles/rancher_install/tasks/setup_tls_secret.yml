---
- name: Check if Rancher TLS secret exists
  ansible.builtin.command:
    cmd: "kubectl -n cattle-system get secret {{ rancher_secret_name }} &>/dev/null"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: secret_check
  failed_when: false
  changed_when: false

- name: Create Rancher TLS secret with full certificate chain
  ansible.builtin.command:
    cmd: >
      kubectl -n cattle-system create secret tls {{ rancher_secret_name }}
      --cert={{ temp_cert_chain_path }}
      --key={{ temp_key_path }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: secret_check.rc != 0
  changed_when: true
