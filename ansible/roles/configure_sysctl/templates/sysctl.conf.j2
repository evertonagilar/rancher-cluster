##############################################################################
# Configurações de Kernel para Cluster Kubernetes - Otimizado
# Última atualização: 2024-06-09
# Responsável: Everton Agilar
##############################################################################

#######################################
## Configurações Essenciais do Kubernetes
#######################################

# Habilita o roteamento de pacotes IPv4 (necessário para o kube-proxy e CNI)
net.ipv4.ip_forward = 1

# Habilita a filtragem iptables para tráfego bridge (requerido pelo Kubernetes)
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# Permite que processos se liguem a endereços IP não locais (útil para serviços LoadBalancer)
net.ipv4.ip_nonlocal_bind = 1

#######################################
## Configurações de Memória e Arquivos
#######################################

# Número máximo de descritores de arquivo (evita erros "too many open files")
fs.file-max = 2097152

# Configurações do inotify (monitoramento de arquivos para kubelet e outros)
# Máximo de arquivos monitorados
fs.inotify.max_user_watches = 524288
# Máximo de instâncias de monitoramento por usuário
fs.inotify.max_user_instances = 256    
# Máximo de eventos na fila
fs.inotify.max_queued_events = 16384   

# Configuração para Elasticsearch (mmap counts para armazenamento de índices)
vm.max_map_count = 262144

# Reduz swapping para melhor performance (0=desativa, 1=minimiza)
vm.swappiness = 0

# Política de overcommit de memória (1=sempre permitir, útil para Kubernetes)
vm.overcommit_memory = 1

#######################################
## Configurações de Rede TCP/IP
#######################################

# Número máximo de conexões em espera (SYN backlog)
net.ipv4.tcp_max_syn_backlog = 32768

# Reutilização de portas TCP (melhor para muitas conexões)
net.ipv4.tcp_tw_reuse = 1

# Tempo de espera em estado FIN-WAIT-2 (liberação mais rápida de conexões)
net.ipv4.tcp_fin_timeout = 30

# Número máximo de buckets TIME-WAIT (prevente esgotamento)
net.ipv4.tcp_max_tw_buckets = 2000000

# Keepalive TCP (detecção mais rápida de conexões mortas)
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10

# Número de retransmissões SYN-ACK (proteção contra SYN flood)
net.ipv4.tcp_synack_retries = 3

# Habilita SYN cookies (proteção contra SYN flood)
net.ipv4.tcp_syncookies = 1

# Buffer de recepção TCP (min, default, max)
net.ipv4.tcp_rmem = 4096 87380 6291456

# Buffer de transmissão TCP (min, default, max)
net.ipv4.tcp_wmem = 4096 16384 4194304

#######################################
## Configurações Gerais de Rede
#######################################

# Número máximo de conexões simultâneas
net.core.somaxconn = 32768

# Faixa de portas efêmeras para conexões de saída
net.ipv4.ip_local_port_range = 1024 65535

# Tamanho máximo da fila de recepção do dispositivo de rede
net.core.netdev_max_backlog = 50000

# Tamanhos padrão e máximo de buffers de socket
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 6291456
net.core.wmem_max = 4194304

# Tabela ARP (útil para grandes clusters)
net.ipv4.neigh.default.gc_thresh3 = 8192

# Filtro de roteamento reverso (segurança)
net.ipv4.conf.all.rp_filter = 1

# Desativa redirecionamentos ICMP (segurança)
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
