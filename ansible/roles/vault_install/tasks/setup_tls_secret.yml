---
- name: Copy certificate to temp location
  ansible.builtin.copy:
    src: "{{ role_path }}/files/{{ cert_file }}"
    dest: "{{ temp_cert_path }}"
    mode: "0644"

- name: Copy private key to temp location
  ansible.builtin.copy:
    src: "{{ role_path }}/files/{{ key_file }}"
    dest: "{{ temp_key_path }}"
    mode: "0600"

- name: Check if vault-tls secret exists
  ansible.builtin.command:
    cmd: kubectl get secret {{ vault_secret_name }} -n {{ vault_namespace }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: vault_tls_secret
  failed_when: false
  changed_when: false

- name: Create Vault TLS secret with CA bundle
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ vault_secret_name }}"
        namespace: "{{ vault_namespace }}"
      type: kubernetes.io/tls
      data:
        tls.crt: "{{ lookup('file', temp_cert_path) | b64encode }}"
        tls.key: "{{ lookup('file', temp_key_path) | b64encode }}"
        ca.crt: "{{ lookup('file', temp_ca_bundle_path) | b64encode }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: vault_tls_secret.rc != 0
